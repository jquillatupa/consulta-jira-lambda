AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Plantilla SAM para validar historias Jira y generar reporte en S3.

  '
Globals:
  Function:
    Runtime: python3.10
    Timeout: 900
    MemorySize: 1024
Resources:
  ValidarHUFunctionLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: validar-hu-libs
      Description: Dependencias Python para Jira + pandas + openpyxl + xlsxwriter
      ContentUri: ..\..\my-layers
      CompatibleRuntimes:
      - python3.10
      LicenseInfo: MIT
  ValidarHUFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ValidarHUFunction
      Handler: app.lambda_handler
      CodeUri: ValidarHUFunction
      Runtime: python3.10
      Layers:
      - Ref: ValidarHUFunctionLayer
      Environment:
        Variables:
          JIRA_DOMAIN:
            Ref: JiraDomainParam
          JIRA_USER:
            Ref: JiraUserParam
          JIRA_API_TOKEN:
            Ref: JiraApiTokenParam
          OUTPUT_S3_BUCKET:
            Ref: OutputS3Bucket
      Policies:
      - S3CrudPolicy:
          BucketName:
            Ref: OutputS3Bucket
    Metadata:
      SamResourceId: ValidarHUFunction
Parameters:
  JiraDomainParam:
    Type: String
    Description: 'Dominio de Jira (por ejemplo: miempresa.atlassian.net)'
  JiraUserParam:
    Type: String
    Description: Usuario de Jira
  JiraApiTokenParam:
    Type: String
    Description: API token de Jira
  OutputS3Bucket:
    Type: String
    Description: "Nombre del bucket S3 donde se subir\xE1n los reportes"
