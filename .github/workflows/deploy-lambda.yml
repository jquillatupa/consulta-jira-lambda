name: Build and Deploy SAM Container Application

on:
  push:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: validarhu-lambda
  STACK_NAME: mi-stack-jira
  JIRA_DOMAIN:      ${{ secrets.JIRA_DOMAIN }}
  JIRA_USER:        ${{ secrets.JIRA_USER }}
  JIRA_API_TOKEN:   ${{ secrets.JIRA_API_TOKEN }}
  OUTPUT_S3_BUCKET: reportes-jira-mi-proyecto-20

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: üÜî Get AWS Account ID
        run: |
          echo "AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_ENV

      - name: üê≥ Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: üè∑Ô∏è Create ECR repo if not exists
        run: |
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY \
            || aws ecr create-repository --repository-name $ECR_REPOSITORY

      - name: üèóÔ∏è Build & Push Docker image
        run: |
          IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${GITHUB_SHA}"
          # 1) Construye s√≥lo con ese tag
          docker build -t $IMAGE_URI .
          # 2) Push al ECR
          docker push $IMAGE_URI

      - name: üèóÔ∏è SAM Build
        run: |
          sam build --cached --use-container

      - name: üöÄ SAM Deploy
        run: |
          IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${GITHUB_SHA}"
          sam deploy \
            --stack-name       $STACK_NAME \
            --region           $AWS_REGION \
            --capabilities     CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --image-repositories "ValidarHUFunction=${IMAGE_URI}" \
            --resolve-s3 \
            --parameter-overrides \
                JiraDomainParam=$JIRA_DOMAIN \
                JiraUserParam=$JIRA_USER \
                JiraApiTokenParam=$JIRA_API_TOKEN \
                OutputS3Bucket=$OUTPUT_S3_BUCKET \
            --no-fail-on-empty-changeset \
            --no-confirm-changeset

